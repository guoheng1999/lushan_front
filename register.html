<!DOCTYPE html>
<html lang="en">

	<head>
		<meta charset="utf-8">
		<meta content="width=device-width, initial-scale=1.0" name="viewport">

		<title>欢迎注册</title>
		<meta content="" name="description">
		<meta content="" name="keywords">

		<!-- Favicons -->
		<link href="assets/img/favicon.ico" rel="icon">
		<link href="assets/img/apple-touch-icon.png" rel="apple-touch-icon">

		<!-- Google Fonts -->
		<link
			href="https://fonts.googleapis.com/css?family=Open+Sans:300,300i,400,400i,600,600i,700,700i|Raleway:300,300i,400,400i,500,500i,600,600i,700,700i|Poppins:300,300i,400,400i,500,500i,600,600i,700,700i"
			rel="stylesheet">

		<!-- Vendor CSS Files -->
		<link href="assets/vendor/animate.css/animate.min.css" rel="stylesheet">
		<link href="assets/vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet">
		<link href="assets/vendor/bootstrap-icons/bootstrap-icons.css" rel="stylesheet">
		<link href="assets/vendor/boxicons/css/boxicons.min.css" rel="stylesheet">
		<link href="assets/vendor/fontawesome-free/css/all.min.css" rel="stylesheet">
		<link href="assets/vendor/glightbox/css/glightbox.min.css" rel="stylesheet">
		<link href="assets/vendor/remixicon/remixicon.css" rel="stylesheet">
		<link href="assets/vendor/swiper/swiper-bundle.min.css" rel="stylesheet">

		<!-- Template Main CSS File -->
		<link href="assets/css/style.css" rel="stylesheet">
		<!--element-ui css-->
		<link rel="stylesheet" href="assets/css/element-ui/theme-chalk/index.css">
		<!--注册-->
		<link href="assets/css/register.css" rel="stylesheet" type="text/css" media="all">
		<link href="assets/css/font-awesome.min.css" rel="stylesheet" type="text/css" media="all">
		<!-- js -->
		<script src="assets/js/jquery.min.js"></script>
		<!-- Vendor JS Files -->
		<script src="assets/vendor/bootstrap/js/bootstrap.bundle.min.js"></script>
		<script src="assets/vendor/glightbox/js/glightbox.min.js"></script>
		<script src="assets/vendor/php-email-form/validate.js"></script>
		<script src="assets/vendor/purecounter/purecounter.js"></script>
		<script src="assets/vendor/swiper/swiper-bundle.min.js"></script>

		<!-- Template Main JS File -->
		<script src="assets/js/main.js"></script>
		<!-- import Vue before Element -->
		<script src="assets/js/vue/vue.js"></script>
		<!-- import element-ui JavaScript -->
		<script src="assets/js/element-ui/lib/index.js"></script>
		<!-- import api.js -->
		<script src="assets/js/axios.js"></script>
		<script src="assets/js/axios.min.js"></script>
		<script src="assets/js/api.js"></script>
		<script src="assets/js/utils/util.js"></script>
	</head>

	<body>

		<!-- ======= Top Bar ======= -->
		<div id="topbar" class="d-flex align-items-center fixed-top">
			<div class="container d-flex justify-content-between">
				<div class="contact-info d-flex align-items-center">
					<i class="bi bi-envelope"></i> <a href="mailto:contact@example.com">contact@example.com</a>
					<i class="bi bi-phone"></i> +1 5589 55488 55
				</div>
				<div class="d-none d-lg-flex social-links align-items-center">
					<a href="#" class="twitter"><i class="bi bi-twitter"></i></a>
					<a href="#" class="facebook"><i class="bi bi-facebook"></i></a>
					<a href="#" class="instagram"><i class="bi bi-instagram"></i></a>
					<a href="#" class="linkedin"><i class="bi bi-linkedin"></i></i></a>
				</div>
			</div>
		</div>

		<!-- ======= Header ======= -->
		<div id="head"></div>
		<script>
			$("#head").load("head.html");
		</script>
		<!-- End Header -->


		<main id="main" style="margin-top: 107.19px;">

			<!-- ======= Breadcrumbs Section ======= -->
			<section class="breadcrumbs">
				<div class="container">

					<div class="d-flex justify-content-between align-items-center">
						<ol>
							<li><a href="index.html">首页</a></li>
							<li>注册</li>
						</ol>
					</div>
				</div>
			</section>
			<!-- End Breadcrumbs Section -->

			<section class="inner-page">
				<div class="main-agileits">
					<div class="sub-main" id="register-form">
						<el-form class="register-form" :model="ruleForm" status-icon :rules="rules" ref="ruleForm"
							class="demo-ruleForm">
							<div class="form-text">
								<el-form-item prop="name">
									<el-input placeholder="姓名" type="text" v-model="ruleForm.name" autocomplete="off">
										<i slot="prefix" class="el-input__icon el-icon-user"></i>
									</el-input>
								</el-form-item>
								<el-form-item prop="email">
									<el-input placeholder="邮箱" type="text" v-model="ruleForm.email" autocomplete="off">
										<i slot="prefix" class="el-input__icon el-icon-message"></i>
									</el-input>
								</el-form-item>
								<el-form-item prop="phone">
									<el-input placeholder="手机号" type="text" v-model="ruleForm.phone" autocomplete="off">
										<i slot="prefix" class="el-input__icon el-icon-phone"></i>
									</el-input>
								</el-form-item>
								<el-form-item prop="organization">
									<el-input placeholder="组织/机构" type="text" v-model="ruleForm.organization"
										autocomplete="off">
										<i slot="prefix" class="el-input__icon el-icon-school"></i>
									</el-input>
								</el-form-item>
								<el-form-item prop="password">
									<el-input placeholder="密码" type="password" v-model="ruleForm.password"
										autocomplete="off">
										<i slot="prefix" class="el-input__icon el-icon-unlock"></i>
									</el-input>
								</el-form-item>
								<el-form-item prop="checkPassword">
									<el-input placeholder="确认密码" type="password" v-model="ruleForm.checkPassword"
										autocomplete="off">
										<i slot="prefix" class="el-input__icon el-icon-lock"></i>
									</el-input>
								</el-form-item>
							</div>
							<div id="form-image">
								<el-form-item prop="fileList">
									<el-upload :headers="headers" class="upload-demo" ref="upload"
										action="http://127.0.0.1:8081/lushan/file/upload/user/proof"
										:accept="acceptFileType" :limit="3" :on-exceed="handleExceed"
										:before-upload="beforeUpload" :on-preview="handlePreview"
										:on-remove="handleRemove" :file-list="ruleForm.fileList" :auto-upload="false">
										<el-button slot="trigger" size="small" type="primary">选取审核文件</el-button>
										<div slot="tip" class="el-upload_tip">只能上传pdf,png, jpg文件,且不超过5M</div>
									</el-upload>
								</el-form-item>
								<el-form-item class="el-register-btn">
									<el-button type="primary" @click="submitForm()">提交</el-button>
									<el-button @click="resetForm()">重置</el-button>
								</el-form-item>
							</div>
						</el-form>
					</div>
					<div class="clear"></div>
				</div>
			</section>

		</main>
		<!-- End #main -->

		<!-- ======= Footer ======= -->
		<footer id="footer">
			<div class="container d-md-flex py-4">

				<div class="me-md-auto text-center text-md-start">
					<div class="copyright">
						&copy; Copyright <strong><span style="font-weight: bold;">中国气象局人工影响天气中心</span></strong>. All
						Rights Reserved
					</div>

				</div>
			</div>
		</footer>
		<!-- End Footer -->

		<a href="#" class="back-to-top d-flex align-items-center justify-content-center"><i
				class="bi bi-arrow-up-short"></i></a>


	</body>

	<script src="assets/js/login/login.js"></script>
	<script>
		new Vue({
			el: '#register-form',
			data() {
				var validatePass = (rule, value, callback) => {
					if (value === '') {
						callback(new Error('请输入密码。'));
					} else {
						if (this.ruleForm.checkPassword !== '') {
							this.$refs.ruleForm.validateField('checkPassword');
						}
						console.log('check pass')
						callback();
					}
				}
				var validatePass2 = (rule, value, callback) => {
					if (value === '') {
						callback(new Error('请再次输入密码。'))
					} else if (value !== this.ruleForm.password) {
						callback(new Error('两次输入密码不一致。'))
					} else {
						console.log('check pass2')
						callback()
					}
				}
				var validateName = (rule, value, callback) => {

					var name = /^([a-zA-Z]|\/| |·|-|●|(\（+\）)|(\（[a-zA-Z]+\）))+$/
					var namesw =
						/^([\u4e00-\u9fa5]|[a-zA-Z]| |•|-|‧|•|⋅|ㆍ|・|●|(\（+\）)|(\（[\u4e00-\u9fa5]+\）)|(\（[a-zA-Z]+\）))+$/
					value = value.replace(' ', '')
					if (name.test(value) || namesw.test(value)) {
						console.log('check name')
						callback()
					} else {
						callback(new Error('请输入您的姓名。'))
					}
				}
				var validateEmail = (rule, value, callback) => {

					var email = /^([a-z0-9_\.-]+)@([\da-z\.-]+)\.([a-z\.]{2,6})$/
					if (email.test(value)) {
						console.log('check email')
						callback()
					} else {
						callback(new Error('请正确输入您的邮箱。'))
					}
				}
				var validatePhone = (rule, value, callback) => {


					var phone = /^1[23456789]\d{9}/;
					if (phone.test(value)) {
						console.log('check phone')
						callback()
					} else {
						callback(new Error('请正确输入您的手机号。'))
					}
				}
				var validateOrganization = (rule, value, callback) => {


					// var organization = /^([\u4e00-\u9fa5]|[a-zA-Z]| |•|-|‧|•|⋅|ㆍ|・|●|(\（+\）)|(\（[\u4e00-\u9fa5]+\）)|(\（[a-zA-Z]+\）))+$/
					if (value.replace(' ', '') == '') {
						callback(new Error('请正确输入您的组织/机构名称。'))
					} else {
						console.log('check org')
						callback()
					}
				}
				var validateFileList = (rule, value, callback) => {


					const mb = 1024 * 1024
					if (this.$refs.upload.uploadFiles.length <= 0) {
						callback(new Error('请上传审核文件，文件格式为pdf、png、jpg且不超过5M！'))
					} else {
						for (var i = 0; i < this.$refs.upload.uploadFiles.length; i++) {
							if (this.$refs.upload.uploadFiles[i].size / mb <= 5) {
								if (this.acceptFileType.indexOf(
										this.$refs.upload.uploadFiles[i].name.split('.').pop()) == -1) {
											console.log(this.$refs.upload.uploadFiles[i])
									this.$refs.upload.uploadFiles.splice(i, 1)
									callback(new Error('上传的审核文件格式应为pdf、png、jpg、jpeg'))
								}
								continue
							} else {
								this.$refs.upload.uploadFiles.splice(i, 1)
								callback(new Error('上传的审核文件应不超过5M'))
							}
						}
						console.log('check list')
						callback()
					}
				}
				return {
					headers: {
						'Access-Control-Allow-Origin': '*',
						'token': sessionStorage.getItem('token')
					},
					httpRequest: 'http://106.13.10.209:8849/lushan/file/upload/user/proof',
					uploadTemplateDialog: false,
					uploadLoading: false,
					acceptFileType: '.jpg, .png, .jpeg, .pdf',
					downLoadLoading: '',
					ruleForm: {
						name: '',
						email: '',
						phone: '',
						organization: '',
						password: '',
						checkPassword: '',
						fileList: []
					},
					rules: {
						password: [{
							validator: validatePass,
							trigger: 'blur'
						}],
						checkPassword: [{
							validator: validatePass2,
							trigger: 'blur'
						}],
						name: [{
							validator: validateName,
							trigger: 'blur'
						}],
						email: [{
							validator: validateEmail,
							trigger: 'blur'
						}],
						phone: [{
							validator: validatePhone,
							trigger: 'blur'
						}],
						organization: [{
							validator: validateOrganization,
							trigger: 'blur'
						}],
						fileList: [{
							validator: validateFileList,
							trigger: 'blur'
						}]
					}
				};
			},
			methods: {
				submitForm() {
					this.$refs['ruleForm'].validate(valid => {
						if (valid) {
							const userInfo = {
								realName: this.ruleForm.name,
								email: this.ruleForm.email,
								phone: this.ruleForm.phone,
								password: this.ruleForm.password,
								organization: this.ruleForm.organization
							}
							userRegister(userInfo).then(res => {
								if (res.data.code === 2000) {
									sessionStorage.setItem('logintoken', res.data.token)
									this.$refs.upload.submit();
									this.resetForm()
									// this.$message({
									// 	type: 'success',
									// 	message: res.data.msg
									// });
								} else {
									this.$message({
										type: 'error',
										showClose: true,
										duration: 3000,
										message: res.data.msg
									});
								}
							})
						} else {
						}
					})
				},
				resetForm() {
					this.ruleForm = {
						name: '',
						email: '',
						phone: '',
						organization: '',
						password: '',
						checkPassword: ''
					}
					this.$refs.upload.uploadFiles = []
				},

				uploadFile() {
					this.uploadLoading = false;
					var that = this;
					this.ruleForm.fileList = [];
					this.uploadTemplateDialog = true;
					setTimeout(function() {
						that.$refs.upload.clearFiles();
					}, 100);
				},
				handleExceed(files, fileList) {
					this.$message.warning('只能选择3个文件。');
				},
				submitUpload() {
					this.uploadLoading = true;
					var that = this;
					setTimeout(function() {
						if (that.$refs.upload.$children[0].fileList.length == 1) {
							that.$refs.upload.submit();
						} else {
							that.uploadLoading = false;
							that.$message({
								type: 'error',
								showClose: true,
								duration: 3000,
								message: '请选择文件!'
							});
						};
					}, 100);
				},
				goBack() {
					window.history.back()
				},
				handleRemove(file, fileList) {
					//console.log(file,fileList);
				},
				handlePreview(file) {
					//console.log(file);
				},
				beforeUpload(file) {
					var that = this; 
					// //文件类型
					// var fileName = file.name.substring(file.name.lastIndexOf('.') + 1);
					// if (!(fileName == 'png' || fileName == 'pdf' || fileName == 'jpg' || fileName == 'jpeg')) {
					// 	that.uploadTemplateDialog = false;
					// 	that.$message({
					// 		type: 'error',
					// 		showClose: true,
					// 		duration: 3000,
					// 		message: '文件类型只支持png，pdf，jpg，jpeg格式!'
					// 	});
					// 	return false;
					// }
					// //读取文件大小
					// var fileSize = file.size;
					// console.log(fileSize);
					// if (fileSize > 1048576 * 5) {
					// 	that.uploadTemplateDialog = false;
					// 	that.$message({
					// 		type: 'error',
					// 		showClose: true,
					// 		duration: 3000,
					// 		message: file.name + '文件大于5M!'
					// 	})
					// 	return false;
					// }
					that.downloadLoading = that.$loading({
						lock: true,
						text: '数据导入中...',
						spinner: 'el-icon-loading',
						background: 'rgba(0,0,0,0.7)'
					})
					let fd = new FormData();
					fd.append('file', file);
					uploadUserProof(fd).then(res => {
						that.downloadLoading.close();
						that.uploadLoading = false;
						let resp = res.data
						if (resp.code == 2000) {
							that.uploadTemplateDialog = false;
							that.$message.success({
								message: '您的注册信息已提交给管理员审核，请等待。',
								duration: 6000,
							});
							//that.queryData();//更新数据
						} else {
							that.uploadTemplateDialog = false;
							that.$message({
								type: 'error',
								showClose: true,
								duration: 60000,
								message: resp.msg
							});
						}
					}).catch(error => {
						that.downloadLoading.close();
						that.uploadLoading = false;
						that.uploadTemplateDialog = false;
						that.$message({
							type: 'error',
							showClose: true,
							duration: 60000,
							message: '请求失败。 error:' + error
						});
					})
					return false;
				}
			}
		})
	</script>
	<style>
		/* 面包屑样式 start*/
		.breadcrumbs {
			margin-top: -3px;
			padding: 0 0;
		}

		.breadcrumbs ol {
			font-size: 16px;
		}

		/* 面包屑样式 end*/
		.el-button--primary,
		.el-button--primary:focus {
			color: #FFF;
			background-color: #1977CC;
			border-color: #1977CC;
		}
	</style>
</html>
