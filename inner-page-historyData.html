<!DOCTYPE html>
<html lang="en">

	<head>
		<meta charset="utf-8">
		<meta content="width=device-width, initial-scale=1.0" name="viewport">

		<title>下载数据</title>
		<meta content="" name="description">
		<meta content="" name="keywords">

		<!-- Favicons -->
		<link href="assets/img/favicon.ico" rel="icon">
		<link href="assets/img/apple-touch-icon.png" rel="apple-touch-icon">

		<!-- Google Fonts -->
		<link
			href="https://fonts.googleapis.com/css?family=Open+Sans:300,300i,400,400i,600,600i,700,700i|Raleway:300,300i,400,400i,500,500i,600,600i,700,700i|Poppins:300,300i,400,400i,500,500i,600,600i,700,700i"
			rel="stylesheet">

		<!-- Vendor CSS Files -->
		<link href="assets/vendor/animate.css/animate.min.css" rel="stylesheet">
		<link href="assets/vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet">
		<link href="assets/vendor/bootstrap-icons/bootstrap-icons.css" rel="stylesheet">
		<link href="assets/vendor/boxicons/css/boxicons.min.css" rel="stylesheet">
		<link href="assets/vendor/fontawesome-free/css/all.min.css" rel="stylesheet">
		<link href="assets/vendor/glightbox/css/glightbox.min.css" rel="stylesheet">
		<link href="assets/vendor/remixicon/remixicon.css" rel="stylesheet">
		<link href="assets/vendor/swiper/swiper-bundle.min.css" rel="stylesheet">
		<!-- import element-ui CSS -->
		<link rel="stylesheet" href="assets/css/element-ui/theme-chalk/index.css">

		<!-- Template Main CSS File -->
		<link href="assets/css/style.css" rel="stylesheet">
		<link href="assets/css/historyData/dataShow.css" rel="stylesheet">
		<link href="assets/css/historyData/inner-page-historyData.css" rel="stylesheet" />
		<!-- 导入阿里的图标样式文件 -->
		<link rel="stylesheet" href="assets/css/iconfont.css">
		<link rel="stylesheet" href="assets/css/left_nav.css">

		<!-- js -->
		<script src="assets/js/jquery.min.js"></script>
		<!-- import Vue before Element -->
		<script src="assets/js/vue/vue.js"></script>
		<!-- import element-ui JavaScript -->
		<script src="assets/js/element-ui/lib/index.js"></script>

		<!-- import api.js -->
		<script src="assets/js/axios.js"></script>
		<script src="assets/js/axios.min.js"></script>
		<script src="assets/js/api.js"></script>
		<script src="assets/js/utils/util.js"></script>
		<!-- =======================================================
  * Template Name: Medilab - v4.3.0
  * Template URL: https://bootstrapmade.com/medilab-free-medical-bootstrap-theme/
  * Author: BootstrapMade.com
  * License: https://bootstrapmade.com/license/
  ======================================================== -->
	</head>

	<body>


		<!-- ======= Header ======= -->
		<div id="head"></div>
		<script>
			$("#head").load("head.html");
		</script>
		<!-- End Header -->


		<main id="main" style="margin-top: 107.19px;">

			<!-- ======= Breadcrumbs Section ======= -->
			<section id="breadcrumbs" class="breadcrumbs">
			</section>
			<script>
				$('#breadcrumbs').load('components/breadcrumbs.html')
			</script>
			<!-- End Breadcrumbs Section -->

			<section class="inner-page">
				<div class="container">
					<div id="history-list" class="row">
						<div class="menu-box">
							<!-- 							<el-menu default-active="1-1-1" :unique-opened="true">
								<el-menu-item index="1-1-1" @click="setDeviceName('A2')"><span
										@click="setDeviceName('A2')"><i class="el-icon-folder"></i>云滴谱分析资料</span>
								</el-menu-item>
								<el-menu-item index="1-1-2" @click="setDeviceName('A3')"><span
										@click="setDeviceName('A3')"><i class="el-icon-folder"></i>云滴谱统计资料</span>
								</el-menu-item>
								<el-menu-item index="1-2" @click="setDeviceName('a')"><span
										@click="setDeviceName('a')"><i class="el-icon-folder"></i>雾滴谱普查资料</span>
								</el-menu-item>
								<el-menu-item index="1-3-1" @click="setDeviceName('B2')"><span
										@click="setDeviceName('B2')"><i class="el-icon-folder"></i>雨滴谱年度统计</span>
								</el-menu-item>
								<el-menu-item index="1-3-2" @click="setDeviceName('B3')"><span
										@click="setDeviceName('B3')"><i class="el-icon-folder"></i>雨滴谱统计总表</span>
								</el-menu-item>
								<el-menu-item index="1-4-1" @click="setDeviceName('C1')"><span
										@click="setDeviceName('C1')"><i class="el-icon-folder"></i>盐核统计资料</span>
								</el-menu-item>
								<el-menu-item index="1-4-2" @click="setDeviceName('C2')"><span
										@click="setDeviceName('C2')"><i class="el-icon-folder"></i>盐核总表</span>
								</el-menu-item>
								<el-menu-item index="1-5" @click="setDeviceName('D1')"><span
										@click="setDeviceName('D1')"><i class="el-icon-folder"></i>宏观记录</span>
								</el-menu-item>
								<el-menu-item index="1-6" @click="setDeviceName('F3')"><span
										@click="setDeviceName('F3')"><i class="el-icon-folder"></i>双经纬仪测云总表</span>
								</el-menu-item>
							</el-menu> -->
							<!-- 云雾滴谱 -->
							<el-menu default-active="1-1-1" :unique-opened="true" v-if="isShow('A')">
								<el-menu-item index="1-1-1" @click="setDeviceName('A2')"><span
										@click="setDeviceName('A2')"><i class="el-icon-folder"></i> 云滴谱分析资料</span>
								</el-menu-item>
								<el-menu-item index="1-1-2" @click="setDeviceName('A3')"><span
										@click="setDeviceName('A3')"><i class="el-icon-folder"></i> 云滴谱统计资料</span>
								</el-menu-item>
								<el-menu-item index="1-2" @click="setDeviceName('a')"><span
										@click="setDeviceName('a')"><i class="el-icon-folder"></i>雾滴谱普查资料</span>
								</el-menu-item>
							</el-menu>
							<!-- 雨滴谱 -->
							<el-menu default-active="1-1-1" :unique-opened="true"  v-if="isShow('B')">
								<el-menu-item index="1-1-1" @click="setDeviceName('B2')"><span
										@click="setDeviceName('A2')"><i class="el-icon-folder"></i> 雨滴谱年度统计</span>
								</el-menu-item>
								<el-menu-item index="1-1-2" @click="setDeviceName('B3')"><span
										@click="setDeviceName('A3')"><i class="el-icon-folder"></i> 雨滴谱统计总表</span>
								</el-menu-item>
							</el-menu>
							<!-- 盐核 -->
							<el-menu default-active="1-1-1" :unique-opened="true"  v-if="isShow('C')">
								<el-menu-item index="1-1-1" @click="setDeviceName('C1')"><span
										@click="setDeviceName('A2')"><i class="el-icon-folder"></i> 盐核统计资料</span>
								</el-menu-item>
								<el-menu-item index="1-1-2" @click="setDeviceName('C2')"><span
										@click="setDeviceName('A3')"><i class="el-icon-folder"></i> 盐核总表</span>
								</el-menu-item>
							</el-menu>
							<!-- 宏观资料 -->
							<el-menu default-active="1-1-1" :unique-opened="true"  v-if="isShow('D')">
								<el-menu-item index="1-1-1" @click="setDeviceName('D1')"><span
										@click="setDeviceName('A2')"><i class="el-icon-folder"></i> 宏观资料</span>
								</el-menu-item>
							</el-menu>
							<!-- 双经纬度测云资料 -->
							<el-menu default-active="1-1-1" :unique-opened="true"  v-if="isShow('F')">
								<el-menu-item index="1-1-1" @click="setDeviceName('F3')"><span
										@click="setDeviceName('A2')"><i class="el-icon-folder"></i> 双经纬仪测云总表</span>
								</el-menu-item>
							</el-menu>
							
						</div>
						<div class="col-lg-9 mt-4 mt-lg-0">
							<div>
								<!-- 历史数据名称列表 -->
								<template>
									<el-table
										:data="historyData.filter(data => !historyDataSearch || data.dataName.toLowerCase().includes(historyDataSearch.toLowerCase())).slice((historyData_currentPage-1)*historyData_pagesize,historyData_currentPage*historyData_pagesize)"
										style="width: 90%" :key='deviceName'>
										<el-table-column min-width="16%" label="文件名" prop="dataName">
										</el-table-column>
										<el-table-column min-width="16%" label="记录时间" prop="logTime">
										</el-table-column>
										<el-table-column min-width="16%" label="站点" prop="station">
										</el-table-column>
										<el-table-column min-width="16%" label="页数" prop="pages">
										</el-table-column>
										<el-table-column min-width="20%" align="right">
											<template slot="header" slot-scope="scope">
												<el-input v-model="historyDataSearch" size="mini"
													placeholder="按文件名搜索" />
											</template>
											<template slot-scope="scope">

												<el-button size="mini" :disabled='isDownload' style="margin-bottom: 5%;"
													@click="download_csvData(scope.$index,scope.row)">
													下载
												</el-button>
												<el-button size="mini" :disabled='isDownload'
													@click="getOriginData(scope.row)" v-if="originalRecord">
													原始记录
												</el-button>
												<!-- 图片列表弹窗 -->

												<el-dialog custom-class="historyData-dialog" :title="dialog_title"
													:visible.sync="dialogVisible"
													style="text-align: center; margin-top: -13vh;">
													<template>
														<el-table ref="multipleTable" max-height="500"
															@selection-change="handleSelectionChange"
															:data="originData.filter(data => !originDataSearch || data.picName.toLowerCase().includes(originDataSearch.toLowerCase())).slice((currentPage-1)*pagesize,currentPage*pagesize)"
															style="width: 100%;padding-left: 10px;">
															<el-table-column align="right">
																<template slot="header" slot-scope="scope">
																	<el-input v-model="originDataSearch" size="mini"
																		placeholder="按图像名搜索" />
																</template>
																<!-- <el-table-column label="编号" prop="id" type="selection">
																</el-table-column> -->
																<el-table-column prop="" label="序号" width="100px">
																	<template slot-scope="scope">
																		{{scope.$index+1}}
																	</template>
																</el-table-column>
																<el-table-column label="链接" width="300px">
																	<template slot-scope="scope">
																		<el-link
																			@click="download_historyImg(scope.row.picName)"
																			type="primary" :disabled='isDownload'>
																			{{scope.row.picName}}
																		</el-link>
																	</template>
																</el-table-column>
															</el-table-column>

														</el-table>
														<el-pagination @size-change="handleSizeChange" small
															@current-change="handleCurrentChange"
															:current-page="currentPage" :page-sizes="[9, 15, 20]"
															:page-size="pagesize" :pager-count="5"
															layout="total, sizes, prev, pager, next, jumper"
															:total="originData.length">
														</el-pagination>
													</template>
													<span slot="footer" class="dialog-footer">
														<!-- <el-button type="primary" @click="download_historySelectImg()">
															下载
														</el-button> -->
													</span>
												</el-dialog>
											</template>
										</el-table-column>
									</el-table>
									<el-pagination @size-change="handleHistorySizeChange"
										@current-change="handleHistoryCurrentChange"
										:current-page="historyData_currentPage" :page-sizes="[10, 20, 50]"
										:page-size="historyData_pagesize"
										layout="total, sizes, prev, pager, next, jumper" :total="historyData.length">
									</el-pagination>
								</template>
								<div class="message-board" v-if="originalRecord">
									<el-button @click="message_board()" style="background-color: transparent;"
										class="message-board-button" icon="el-icon-chat-round">
									</el-button>
									<span>数据反馈</span>
									<el-drawer append-to-body title="数据反馈" :visible.sync="messageBoardVisible"
										direction="rtl" size="400px">
										<el-form :model='feedbackForm' :rules="feedbackRules" ref="feedbackForm">
											<div class="block">
												<el-cascader class="demonstration cascader"
													v-model="feedbackForm.folder" :options="folders"
													:props="{ expandTrigger: 'hover' }" @change="handleChange"
													placeholder="请选择需要反馈的数据名称">
												</el-cascader>
											</div>
											<el-form-item prop="content">
												<el-input type="textarea" :rows="9" placeholder="请输入您的反馈信息"
													v-model="feedbackForm.message_board_text">
												</el-input>
											</el-form-item>
											<div id="form-image">
												<el-form-item prop="fileList">
													<el-upload :headers="headers" class="upload-demo" ref="upload"
														action="http://127.0.0.1:8081/lushan/file/upload/commentFile"
														:accept="acceptFileType" :limit="3" :on-exceed="handleExceed"
														:before-upload="beforeUpload" :on-preview="handlePreview"
														:on-remove="handleRemove" :file-list="feedbackForm.fileList"
														:auto-upload="false">
														<el-button class="login-button" slot="trigger" size="small"
															type="primary">选取相关信息文件
														</el-button>
														<div slot="tip" class="el-upload_tip">只能上传pdf,png, jpg文件,且不超过5M
														</div>
													</el-upload>
												</el-form-item>
											</div>
											<div class="demo-drawer__footer">
												<el-button @click="cancelForm">取 消</el-button>
												<el-button class="login-button" type="primary" @click="submitForm()">
													提 交
												</el-button>
											</div>
										</el-form>
									</el-drawer>
								</div>
							</div>

						</div>
					</div>
				</div>
				</div>
			</section>

		</main>
		<!-- End #main -->

		<!-- ======= Footer ======= -->
		<footer id="footer">
			<div class="container d-md-flex py-4">

				<div class="me-md-auto text-center text-md-start">
					<div class="copyright">
						&copy; Copyright <strong><span>中国气象局人工影响天气中心</span></strong>. All Rights Reserved
					</div>

				</div>
			</div>
		</footer>
		<!-- End Footer -->

		<a href="#" class="back-to-top d-flex align-items-center justify-content-center"><i
				class="bi bi-arrow-up-short"></i></a>

		<!-- Vendor JS Files -->
		<script src="assets/vendor/bootstrap/js/bootstrap.bundle.min.js"></script>
		<script src="assets/vendor/glightbox/js/glightbox.min.js"></script>
		<script src="assets/vendor/php-email-form/validate.js"></script>
		<script src="assets/vendor/purecounter/purecounter.js"></script>
		<script src="assets/vendor/swiper/swiper-bundle.min.js"></script>

		<!-- Template Main JS File -->
		<script src="assets/js/main.js"></script>
	</body>
	<!-- <script src="assets/js/login/login.js"></script> -->
	<!-- <script src="assets/js/components/breadcrumbs.js"></script> -->
	<script>
		new Vue({
			el: '#history-list',
			data() {
				var validateContent = (rule, value, callback) => {
					// console.log('content验证')
					if (value === '') {
						callback(new Error('请输入具体内容'));
					}
					callback()
				}
				var validateFolder = (rule, value, callback) => {
					// console.log('folder验证')
					if (value === '') {
						callback(new Error('请选择需要反馈的数据！'));
					}
					callback()
				}
				var validateFileList = (rule, value, callback) => {
					// console.log('list验证')
					const mb = 1024 * 1024
					if (this.$refs.upload.uploadFiles.length <= 0) {
						callback()
					} else {
						for (var i = 0; i < this.$refs.upload.uploadFiles.length; i++) {
							if (this.$refs.upload.uploadFiles[i].size / mb > 10) {
								this.$refs.upload.uploadFiles.splice(i, 1)
								callback(new Error('上传的审核文件应不超过5M'))
							}
						}
						callback()
					}
				}
				return {
					headers: {
						'Access-Control-Allow-Origin': '*',
						'token': sessionStorage.getItem('token')
					},
					src: 'assets/img/about.jpg',
					dialog_title: '',
					originalRecord: false, //原始记录按钮默认不可见
					deviceName: '', //当前设备默认显示云滴谱数据A2
					historyData: [],
					originData: [],
					userForm: {
						email: ''
					}, //用户信息列表
					historyDataSearch: '',
					originDataSearch: '',
					dialogVisible: false,
					img_dialogVisible: false,
					historyData_currentPage: 1,
					historyData_pagesize: 10,
					currentPage: 1,
					pagesize: 9,
					//dataShow
					checkAll: false,
					isIndeterminate: true,
					messageBoardVisible: false,
					loading: false,
					timer: null,
					isDownload: false,
					acceptFileType: '.jpg, .png, .jpeg, .pdf',
					commentId: null,
					showDataName: 'D',
					folders: [{
						value: '云滴谱分析资料',
						label: '云滴谱分析资料'
					}, {
						value: '云滴谱统计资料',
						label: '云滴谱统计资料'
					}, {
						value: '雾滴谱普查资料',
						label: '雾滴谱普查资料'

					}, {
						value: '雨滴谱年度统计',
						label: '雨滴谱年度统计'
					}, {
						value: '雨滴谱统计总表',
						label: '雨滴谱统计总表'

					}, {
						value: '盐核统计资料',
						label: '盐核统计资料'
					}, {
						value: '盐核总表',
						label: '盐核总表'
					}, {
						value: '宏观记录',
						label: '宏观记录'
					}, {
						value: '双经纬仪测云总表',
						label: '双经纬仪测云总表'
					}],
					feedbackForm: {
						message_board_text: '',
						folder: '',
						fileList: [],
					},
					feedbackRules: {
						content: [{
							validator: validateContent,
							trigger: 'blur'
						}],
						fileListRule: [{
							validator: validateFileList,
							trigger: 'blur'
						}],
						folder: [{
							validator: validateFolder,
							trigger: 'blur'
						}]
					},
				}
			},
			watch: {
				deviceName(newData, oldData) {
					getHistoryData(this.deviceName)
						.then(res => {
							res = res.data
							if (res.code == 2000) {
								this.historyData = res.data
							} else {
								this.$message({
									type: 'info',
									message: res.msg
								})
							}
						})
						.catch(err => {
							this.loading = false
							this.$message.error('历史数据获取失败，请稍后重试！')
						})
				}
			},
			// 创建完毕状态(里面是操作)
			created() {
				this.getUserList()
				this.setDeviceName(this.getShowDataName())
			},
			methods: {
				// 获取用户信息以确定是否显示原始记录
				getUserList() {
					if (sessionStorage.getItem('userInfo') == null) {
						return
					}
					const roleId = JSON.parse(sessionStorage.getItem('userInfo')).roleId
					if (roleId >= 1) {
						this.originalRecord = true
					}
				},
				download_historyImg(picName) {
					const dataName = this.dialog_title.split(' 的原始记录')[0]

					const params = {
						dataName: dataName,
						picName: picName
					}
					console.log(params)
					this.isDownload = true
					const serverMessage = this.$message({
						type: 'success',
						message: '请您稍等，服务器正在准备数据。',
						duration: 0
					})
					/*下载原始记录的图片*/
					downloadHistoryImg(params).then(res => {
						let blob = new Blob([res.data])
						let contentDisposition = res.headers[
							'content-disposition'
						] //从response的headers中获取filename, 后端response.setHeader("Content-disposition", "attachment; filename=xxxx.docx") 设置的文件名;
						let patt = new RegExp('filename=([^;]+\\.[^\\.;]+);*')
						let result = patt.exec(contentDisposition)
						console.log(result)
						let thename = decodeURI(result[1]) //使用decodeURI对名字进行解码
						let downloadElement = document.createElement('a')
						let href = window.URL.createObjectURL(blob) //创建下载的链接
						downloadElement.style.display = 'none'
						downloadElement.href = href
						downloadElement.download = thename //下载后文件名
						document.body.appendChild(downloadElement)
						downloadElement.click() //点击下载
						document.body.removeChild(downloadElement) //下载完成移除元素
						window.URL.revokeObjectURL(href) //释放掉blob对象
						this.isDownload = false
						serverMessage.close()
					}).catch(err => {
						this.$message({
							type: 'error',
							message: '系统错误，请稍后重试或联系管理员！'
						})
						this.isDownload = false
						serverMessage.close()
					})
				},
				/*设置设备名称并获取相关历史数据*/
				setDeviceName(params) {
					this.deviceName = params
					this.historyData_currentPage = 1
				},
				// 初始页currentPage、初始每页数据数pagesize和数据data
				handleSizeChange: function(size) {
					this.pagesize = size;
					console.log(this.pagesize) //每页下拉显示数据
				},
				handleHistorySizeChange: function(size) {
					this.historyData_pagesize = size;
					console.log(this.pagesize) //每页下拉显示数据
				},
				handleCurrentChange: function(currentPage) {
					this.currentPage = currentPage;
					console.log(this.currentPage) //点击第几页
				},
				handleHistoryCurrentChange: function(currentPage) {
					this.historyData_currentPage = currentPage;
					console.log(this.currentPage) //点击第几页
				},
				// handleUserList() {
				//     this.$http.get('http://localhost:3000/userList').then(res => {  //这是从本地请求的数据接口，
				//     this.userList = res.body
				// })
				handleCheckAllChange(val) {
					this.checkedCities = val ? cityOptions : [];
					this.isIndeterminate = false;
				},
				handleCheckedCitiesChange(value) {
					let checkedCount = value.length;
					this.checkAll = checkedCount === this.cities.length;
					this.isIndeterminate = checkedCount > 0 && checkedCount < this.cities.length;
				},
				download_csvData(index, data) {
					console.log(index, data); //点击第几页
					const token = sessionStorage.getItem('logintoken') || ''
					if (token != null && token != '') {
						this.isDownload = true
						const serverMessage = this.$message({
							type: 'success',
							message: '请您稍等，服务器正在准备数据。',
							duration: 0
						})
						const params = {
							dataName: data.dataName
						};
						downloadHistoryData(params)
							.then(res => {
								let blob = new Blob([res.data])
								let contentDisposition = res.headers[
									'content-disposition'
								] //从response的headers中获取filena me, 后端response.setHeader("Content-disposition", "attachment; filename=xxxx.docx") 设置的文件名;
								let patt = new RegExp('filename=([^;]+\\.[^\\.;]+);*')
								let result = patt.exec(contentDisposition)
								console.log(result)
								let thename = decodeURI(result[1]) //使用decodeURI对名字进行解码
								let downloadElement = document.createElement('a')
								let href = window.URL.createObjectURL(blob) //创建下载的链接
								downloadElement.style.display = 'none'
								downloadElement.href = href
								downloadElement.download = thename //下载后文件名
								document.body.appendChild(downloadElement)
								downloadElement.click() //点击下载
								document.body.removeChild(downloadElement) //下载完成移除元素
								window.URL.revokeObjectURL(href) //释放掉blob对象
								this.isDownload = false
								serverMessage.close()
							})
							.catch(err => {
								console.log(err)
								// this.loading = false
								this.$message({
									type: 'error',
									message: '系统错误，请稍后重试或联系管理员！'
								})
								this.isDownload = false
								serverMessage.close()
							})
					} else {
						this.$confirm('提示', {
								message: '请您登录后再进行下载。',
								confirmButtonText: '登录',
								cancelButtonText: '取消',
								type: 'warning'
							})
							.then(() => {
								window.location.href = "login.html"
							})
							.catch(() => {
								this.$message({
									type: 'info',
									message: '已取消登录！'
								})
							})
					}
				},
				toggleSelection(rows) {
					if (rows) {
						rows.forEach(row => {
							this.$refs.multipleTable.toggleRowSelection(row);
						});
					} else {
						this.$refs.multipleTable.clearSelection();
					}
				},
				handleSelectionChange(val) {
					this.multipleSelection = val;
				},
				//获取原始记录
				getOriginData(row) {
					this.dialog_title = row.dataName + " 的原始记录"
					this.dialogVisible = true
					getOriginDataList(row.dataName)
						.then(res => {
							res = res.data
							if (res.code == 2000) {
								this.originData = res.data
							} else {
								this.$message({
									type: 'info',
									message: res.msg
								})
							}
						})
						.catch(err => {
							// this.loading = false
							this.$message.error('获取原始记录失败，请稍后重试！')
						})
				},
				getShowDataName(){
					if (window.location.href.indexOf("showDataName=") != -1){
						this.showDataName = window.location.href.split("showDataName=")[1].slice(0, 2)
						console.log(window.location.href.split("showDataName=")[1].slice(0, 2))
						return window.location.href.split("showDataName=")[1].slice(0, 2)
					}
					return 'A2'
				},
				message_board() {
					//留言板
					this.messageBoardVisible = true
				},
				handleChange(value) {
					console.log(value);
				},
				isShow(dataName){
					if (dataName == this.showDataName.slice(0, 1))
						return true
					return false
				},
				cancelForm() {
					this.loading = false;
					this.messageBoardVisible = false;
					clearTimeout(this.timer);
					this.resetForm();
				},
				handleRemove(file, fileList) {
					//console.log(file);
				},
				handlePreview(file) {
					//console.log(file);
				},
				beforeUpload(file) {
					var that = this;
					//文件类型
					var fileName = file.name.substring(file.name.lastIndexOf('.') + 1);
					if (!(fileName == 'png' || fileName == 'pdf' || fileName == 'jpg')) {
						that.uploadTemplateDialog = false;
						that.$message({
							type: 'error',
							showClose: true,
							duration: 3000,
							message: '文件类型只支持png，pdf，jpg格式!'
						});
						return false;
					}
					//读取文件大小
					var fileSize = file.size;
					console.log(fileSize);
					if (fileSize > 1048576 * 5) {
						that.uploadTemplateDialog = false;
						that.$message({
							type: 'error',
							showClose: true,
							duration: 3000,
							message: file.name + '文件大于5M!'
						})
						return false;
					}
					that.downloadLoading = that.$loading({
						lock: true,
						text: '数据导入中...',
						spinner: 'el-icon-loading',
						background: 'rgba(0,0,0,0.7)'
					})
					let fd = new FormData();
					fd.append('file', file);
					fd.append('commentId', this.commentId)
					uploadCommentFile(fd).then(res => {
						that.downloadLoading.close();
						that.uploadLoading = false;
						let resp = res.data
						if (resp.code == 2000) {
							that.uploadTemplateDialog = false;
							that.$message.success({
								message: '您的反馈已提交，谢谢。',
								duration: 6000,
							});
							this.resetForm()
							//that.queryData();//更新数据
						} else {
							that.uploadTemplateDialog = false;
							that.$message({
								type: 'error',
								showClose: true,
								duration: 60000,
								message: resp.msg
							});
						}
						this.commentId = null
					}).catch(error => {
						that.downloadLoading.close();
						that.uploadLoading = false;
						that.uploadTemplateDialog = false;
						that.$message({
							type: 'error',
							showClose: true,
							duration: 60000,
							message: '请求失败! error:' + error
						});
					})
					return false;
				},
				handleExceed(files, fileList) {
					this.$message.warning('只能选择3个文件!');
				},
				submitForm() {
					console.log('开始提交。。。。')

					this.$refs['feedbackForm'].validate(valid => {
						console.log('提交的if之前');
						if (valid) {
							const feedbackMessage = {
								topic: this.feedbackForm.folder,
								content: this.feedbackForm.message_board_text
							}
							console.log(feedbackMessage)
							feedbackData(JSON.stringify(feedbackMessage)).then(res => {
								if (res.data.code === 2000) {
									this.commentId = res.data.data.id
									this.$refs.upload.submit();
									this.loading.close()
									this.$message({
										type: 'success',
										message: res.data.msg
									});
								} else {
									this.$message({
										type: 'error',
										showClose: true,
										duration: 3000,
										message: res.data.msg
									});
								}
							})
						} else {
							console.log('未进入if')
						}
					})


				},
				resetForm() {
					this.feedbackForm.folder = '',
						this.feedbackForm.message_board_text = ''
					this.$refs.upload.uploadFiles = []
				}
			}
		})
	</script>
</html>
